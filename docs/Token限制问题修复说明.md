# OpenAI Embedding API Token é™åˆ¶é—®é¢˜ä¿®å¤è¯´æ˜

## ğŸ› é—®é¢˜æè¿°

### é”™è¯¯ä¿¡æ¯
```
Error code: 400 - {'error': {
    'message': 'Requested 403542 tokens, max 300000 tokens per request',
    'type': 'max_tokens_per_request',
    'param': None,
    'code': 'max_tokens_per_request'
}}
```

### é”™è¯¯åœºæ™¯
- **è§¦å‘æ¡ä»¶**: å¤„ç†å¤§å‹æ–‡æ¡£ï¼ˆå¦‚é•¿ç¯‡ä¹¦ç±ï¼‰
- **å‘ç”Ÿä½ç½®**: RAG æŒä¹…åŒ–èŠ‚ç‚¹ â†’ `vector_store.add_texts()`
- **å¤±è´¥æ¡ˆä¾‹**: ã€Šç‹å¾·å³°ä¼ ä¹ å½•ã€‹ï¼Œ310,053 å­—ç¬¦ï¼Œ410 ä¸ªæ–‡æœ¬å—

## ğŸ” æ ¹æœ¬åŸå› 

### OpenAI API é™åˆ¶
- **text-embedding-3-large** å•æ¬¡è¯·æ±‚æœ€å¤š **300,000 tokens**
- å½“æ–‡æ¡£åˆ†å—æ•°é‡è¾ƒå¤šæ—¶ï¼Œä¸€æ¬¡æ€§å‘é‡åŒ–ä¼šè¶…é™

### åŸå§‹ä»£ç é—®é¢˜

```python
# vector_store.py ç¬¬ 80 è¡Œï¼ˆä¿®å¤å‰ï¼‰
def add_texts(self, texts, metadatas):
    # âŒ é—®é¢˜ï¼šä¸€æ¬¡æ€§å¤„ç†æ‰€æœ‰æ–‡æœ¬
    embeddings = self.embedding_model.embed_documents(texts_list)
    # 410 ä¸ªå— Ã— 985 tokens/å— â‰ˆ 403,542 tokens > 300,000 é™åˆ¶
```

## âœ… ä¿®å¤æ–¹æ¡ˆ

### æ‰¹é‡åˆ†æ‰¹å¤„ç†

```python
# vector_store.py ç¬¬ 71-129 è¡Œï¼ˆä¿®å¤åï¼‰
def add_texts(self, texts, metadatas):
    # âœ… è§£å†³æ–¹æ¡ˆï¼šåˆ†æ‰¹å¤„ç†
    batch_size = 100  # æ¯æ‰¹æœ€å¤š 100 ä¸ªå—
    all_embeddings = []
    
    for i in range(0, len(texts_list), batch_size):
        batch_texts = texts_list[i:i+batch_size]
        batch_num = i // batch_size + 1
        total_batches = (len(texts_list) + batch_size - 1) // batch_size
        
        print(f"  æ­£åœ¨å‘é‡åŒ–ç¬¬ {batch_num}/{total_batches} æ‰¹...")
        
        # åˆ†æ‰¹è°ƒç”¨ API
        batch_embeddings = self.embedding_model.embed_documents(batch_texts)
        all_embeddings.extend(batch_embeddings)
        
        print(f"  âœ… ç¬¬ {batch_num} æ‰¹å®Œæˆ")
    
    # åˆå¹¶æ‰€æœ‰æ‰¹æ¬¡çš„ embeddings
    embeddings_np = np.array(all_embeddings, dtype='float32')
    # ... åç»­å¤„ç†
```

### ä¿®å¤æ•ˆæœ

**å¤„ç†ã€Šç‹å¾·å³°ä¼ ä¹ å½•ã€‹çš„æƒ…å†µï¼š**
```
410 ä¸ªå— Ã· 100 å—/æ‰¹ = 5 æ‰¹

æ‰¹æ¬¡ 1: å— 1-100   (çº¦ 100,000 tokens) âœ…
æ‰¹æ¬¡ 2: å— 101-200 (çº¦ 100,000 tokens) âœ…
æ‰¹æ¬¡ 3: å— 201-300 (çº¦ 100,000 tokens) âœ…
æ‰¹æ¬¡ 4: å— 301-400 (çº¦ 100,000 tokens) âœ…
æ‰¹æ¬¡ 5: å— 401-410 (çº¦ 10,000 tokens)  âœ…

æ€»è®¡: 5 æ¬¡ API è°ƒç”¨ï¼Œæ¯æ¬¡éƒ½åœ¨é™åˆ¶å†…
```

## ğŸ“Š æ€§èƒ½å½±å“

### API è°ƒç”¨æ¬¡æ•°å¢åŠ 
- **å°æ–‡æ¡£** (< 100 å—): æ— å½±å“ï¼Œä»ç„¶ 1 æ¬¡è°ƒç”¨
- **ä¸­å‹æ–‡æ¡£** (100-200 å—): 2 æ¬¡è°ƒç”¨
- **å¤§å‹æ–‡æ¡£** (400+ å—): 5+ æ¬¡è°ƒç”¨

### å¤„ç†æ—¶é—´å¢åŠ 
- æ¯æ‰¹ API è°ƒç”¨çº¦ 2-3 ç§’
- 410 ä¸ªå—ï¼šä» 1 æ¬¡è°ƒç”¨ï¼ˆå¤±è´¥ï¼‰â†’ 5 æ¬¡è°ƒç”¨ï¼ˆæˆåŠŸï¼‰
- é¢å¤–æ—¶é—´ï¼šçº¦ 8-12 ç§’

### æƒè¡¡
- âœ… **æ”¶ç›Š**: æ”¯æŒä»»æ„å¤§å°çš„æ–‡æ¡£
- âš ï¸ **ä»£ä»·**: å¤§æ–‡æ¡£å¤„ç†æ—¶é—´ç•¥å¾®å¢åŠ 
- ğŸ¯ **ç»“è®º**: å®Œå…¨å€¼å¾—ï¼Œå› ä¸ºåŸæ–¹æ¡ˆç›´æ¥å¤±è´¥

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### æ‰¹æ¬¡å¤§å°é€‰æ‹© (batch_size = 100)

**è®¡ç®—ä¾æ®ï¼š**
```
å‡è®¾æ¯ä¸ªæ–‡æœ¬å—å¹³å‡ 1000 å­—ç¬¦
ä¸­è‹±æ··åˆæ–‡æœ¬ï¼šçº¦ 2.5 å­—ç¬¦/token
æ¯å—çº¦ 400 tokens

100 å— Ã— 400 tokens = 40,000 tokens < 300,000 é™åˆ¶ âœ…

ä¿å®ˆä¼°è®¡ï¼šå³ä½¿æ¯å— 2000 å­—ç¬¦ï¼ˆ800 tokensï¼‰
100 å— Ã— 800 tokens = 80,000 tokens < 300,000 é™åˆ¶ âœ…
```

### é”™è¯¯å¤„ç†
- æ¯æ‰¹éƒ½æœ‰ç‹¬ç«‹çš„ try-catch
- å¦‚æœæŸæ‰¹å¤±è´¥ï¼Œç«‹å³æŠ›å‡ºå¼‚å¸¸å¹¶ä¸­æ­¢
- é¿å…éƒ¨åˆ†æˆåŠŸéƒ¨åˆ†å¤±è´¥çš„æ•°æ®ä¸ä¸€è‡´é—®é¢˜

## ğŸ“ ç”¨æˆ·ä½“éªŒæ”¹è¿›

### æ§åˆ¶å°è¾“å‡ºç¤ºä¾‹

**ä¿®å¤å‰ï¼š**
```
ï¼ˆç›´æ¥æŠ¥é”™ï¼Œæ— è¿›åº¦æç¤ºï¼‰
Error code: 400 - Requested 403542 tokens...
```

**ä¿®å¤åï¼š**
```
å¼€å§‹å‘é‡åŒ– 410 ä¸ªæ–‡æœ¬å—...
  æ­£åœ¨å‘é‡åŒ–ç¬¬ 1/5 æ‰¹ (100 ä¸ªå—)...
  âœ… ç¬¬ 1 æ‰¹å®Œæˆ
  æ­£åœ¨å‘é‡åŒ–ç¬¬ 2/5 æ‰¹ (100 ä¸ªå—)...
  âœ… ç¬¬ 2 æ‰¹å®Œæˆ
  æ­£åœ¨å‘é‡åŒ–ç¬¬ 3/5 æ‰¹ (100 ä¸ªå—)...
  âœ… ç¬¬ 3 æ‰¹å®Œæˆ
  æ­£åœ¨å‘é‡åŒ–ç¬¬ 4/5 æ‰¹ (100 ä¸ªå—)...
  âœ… ç¬¬ 4 æ‰¹å®Œæˆ
  æ­£åœ¨å‘é‡åŒ–ç¬¬ 5/5 æ‰¹ (10 ä¸ªå—)...
  âœ… ç¬¬ 5 æ‰¹å®Œæˆ
æ­£åœ¨å­˜å‚¨æ–‡æœ¬å—åˆ° SQLite...
æ­£åœ¨å­˜å‚¨å‘é‡åˆ° FAISS ç´¢å¼•...
âœ… æˆåŠŸæ·»åŠ  410 ä¸ªå—åˆ° RAG å­˜å‚¨ã€‚
```

### ä¼˜åŠ¿
1. æ¸…æ™°çš„è¿›åº¦æç¤º
2. è®©ç”¨æˆ·çŸ¥é“ç³»ç»Ÿåœ¨æ­£å¸¸å·¥ä½œ
3. ä¾¿äºå®šä½é—®é¢˜ï¼ˆå¦‚æœæŸæ‰¹å¤±è´¥ï¼‰

## ğŸ¯ æ€»ç»“

| é¡¹ç›® | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| æ”¯æŒæ–‡æ¡£å¤§å° | < 200 å— | æ— é™åˆ¶ âœ… |
| API è°ƒç”¨æ¬¡æ•° | 1 æ¬¡ | (å—æ•°Ã·100) æ¬¡ |
| å¤„ç†æ—¶é—´ | å¿« | ç•¥æ…¢ä½†å¯é  |
| ç”¨æˆ·ä½“éªŒ | æ— è¿›åº¦æç¤º | æ¸…æ™°è¿›åº¦æ˜¾ç¤º âœ… |
| é”™è¯¯å¤„ç† | ç›´æ¥å¤±è´¥ | åˆ†æ‰¹å¯æ§ âœ… |

**ç»“è®º**: ä¿®å¤åç³»ç»Ÿæ›´åŠ å¥å£®ï¼Œå¯ä»¥å¤„ç†ä»»æ„å¤§å°çš„æ–‡æ¡£ï¼Œç”¨æˆ·ä½“éªŒä¹Ÿæ›´å¥½ï¼

