# DeepReader 架构深度解析

## 1. 概述 (Overview)

DeepReader 是一个基于 **LangGraph** 构建的高级多智能体（Multi-Agent）文档分析系统，旨在对长文本进行“主动阅读”和深度综合。与简单的摘要工具不同，它模拟了人类研究员的工作流：迭代阅读、提出问题、查阅前后文、并根据特定的用户提问综合生成一份结构化的报告。

## 2. 核心架构 (Core Architecture)

系统作为一个状态机运行，定义在 `backend/read_graph.py` 中。核心状态对象 (`DeepReaderState`) 负责在各个节点之间传递数据。

### 高层工作流
1.  **摄入与索引 (`RAGPersistenceNode`)**：构建“全局记忆”。
2.  **迭代阅读循环 (`IterativeReadingLoop`)**：即“主动阅读”阶段。智能体按顺序阅读，但具备全局视野。
3.  **全局综合与写作 (`ReportGenerationNode`)**：即“写作研讨会”阶段。智能体辩论主题并撰写结构化报告。

## 3. 详细工作流分析 (Detailed Workflow Analysis)

### 第一阶段：摄入 (Ingestion - The Foundation)
*   **输入**：源文档（已转换为 Markdown）。
*   **动作**：
    *   文档被切分为小片段（Chunks）。
    *   创建一个混合向量存储库 (`DeepReaderVectorStore`)，使用 FAISS 进行语义搜索，使用 SQLite 存储元数据和文本。
    *   **目的**：建立“长期记忆”，允许智能体随时从书中的任何位置查找信息。

### 第二阶段：迭代阅读循环 (Iterative Reading Loop - The Active Reader)
这是核心创新点。系统不仅是一块一块地总结，而是构建累积性的理解。

*   **流程**：文档被分割成逻辑片段（如章节）。
*   **智能体团队**：
    1.  **阅读智能体 (Reading Agent)**：
        *   **角色**：阅读当前片段。
        *   **产出**：子章节摘要 + 基于文本产生的**深度思考问题 (Critical Questions)**。
        *   **策略**：被指示将当前内容与“前序章节上下文”联系起来。
    2.  **审阅/回顾智能体 (Reviewer Agent - RAG Powered)**：
        *   **角色**：事实核查员与研究员。
        *   **动作**：获取阅读智能体提出的“深度问题”，并在**全局向量库**中检索答案。
        *   **为什么重要？**：这允许智能体在阅读第1章时，就能通过第10章的信息来回答疑问，建立整体观。
    3.  **关键信息智能体 (Key Info Agent)**：
        *   **角色**：数据分析师。
        *   **动作**：提取与用户核心问题相关的、可引用的具体数据点（数字、引用）。
    4.  **总结智能体 (Summary Agent)**：
        *   **角色**：综合者。
        *   **动作**：更新“背景记忆 (Background Memory)”，将新的片段摘要 + RAG 检索到的答案融合。这个“滚动记忆”会被传递给下一次迭代。

### 第三阶段：报告生成 (Report Generation - The Writing Workshop)
阅读完成后，系统进入由 `ReportGenerationNode` 管理的“写作研讨会”模式。

*   **步骤 1: 脉络分析 (Narrative Analysis)**：
    *   **智能体**：脉络分析师 (Narrative Analyst)。
    *   **任务**：审查所有章节摘要，梳理书籍的逻辑流向（不仅仅是线性目录）。
*   **步骤 2: 主题提炼 (Thematic Extraction)**：
    *   **智能体**：主题思想家 (Thematic Thinker)。
    *   **任务**：提炼“核心观点”、“核心结论”和“核心证据”，必须严格对齐用户的核心提问。
*   **步骤 3: 辩论 (Critique & Refine)**：
    *   **智能体**：批判性思维者 (Critical Thinker) vs 主题思想家。
    *   **动作**：批判者挑战提炼出的主题（“这真的回答了用户的问题吗？”）。思想家进行优化。此过程会循环多轮（配置中的 `debate_rounds`）。
*   **步骤 4: 大纲生成 (Outline Generation)**：
    *   **智能体**：总编辑 (Chief Editor)。
    *   **任务**：创建最终报告的分层大纲，确保每个章节都服务于回答用户的问题。
*   **步骤 5: 迭代写作 (Iterative Writing)**：
    *   **智能体**：作家 (Writer)。
    *   **机制**：
        *   针对大纲的**每一个**章节，系统执行**动态上下文选择 (Dynamic Context Selection)**：
            *   **摘要**：筛选最相关的前5个章节摘要。
            *   **关键信息**：筛选相关的数据点。
            *   **RAG**：针对该章节主题进行全新的向量搜索。
        *   **写作**：利用这些针对性的素材生成章节文本。

## 4. 数据流与状态管理 (Data Flow)

`DeepReaderState`（位于 `backend/read_state.py`）是贯穿整个图的数据总线，承载：
*   `user_core_question`：所有智能体的指路明灯（用户的核心问题）。
*   `chapter_summaries`：所有章节摘要的字典。
*   `key_information`：提取出的关键数据点列表。
*   `active_memory`：滚动的背景摘要。
*   `db_name`：向量数据库的引用。
*   `raw_reviewer_outputs`：阅读过程中产生的所有问答对记录。

## 5. 关键提示词与角色 (Key Prompts & Personas)

系统依赖于强大的人设提示词（位于 `backend/prompts.py`）：

| 智能体角色 | 人设 | 关键指令 |
| :--- | :--- | :--- |
| **阅读智能体** | 研究员 | “提出更深层的问题……展示与前文的联系。” |
| **审阅智能体** | 事实核查员 | “严格基于提供的上下文回答……如果信息不可用请直说。” |
| **脉络分析师** | 叙事分析师 | “识别潜在的逻辑结构……超越线性的章节呈现。” |
| **批判性思维者** | 魔鬼代言人 | “挑战主题分析……确保其回答了用户的核心问题。” |
| **作家** | 高级分析师 | “超越表面总结……连接观点……主动引用数据。” |

## 6. 创新点总结 (Summary of Innovation)

DeepReader 的独特之处在于：
1.  **打破线性限制**：通过审阅智能体/RAG，它允许在理解早期章节时参考后续章节的内容。
2.  **自我修正**：辩论机制（Debate Mechanism）防止幻觉，并确保始终聚焦于用户的特定查询。
3.  **动态上下文**：作家不会简单地堆砌所有上下文；它使用智能选择算法为每个特定章节挑选**最正确**的摘要和数据。
